<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Streaming App</title>
    <link rel="stylesheet" href="csstv.css">
    <link rel="icon" type="image/vnd.icon" href="logo.jpg">
</head>

<body>
    <h1>üì∫ TV Streaming 11</h1>

    <div class="search-container">
        <input type="text" id="searchBar" class="search-bar" placeholder="Rechercher une cha√Æne...">
    </div>

    <div class="container" id="channels"></div>

    <div class="server-list" id="serverList">
        <div id="serverContent"></div>
    </div>

    <script>
        let channels = [];
        let currentIndex = -1;       // -1 = barre de recherche "active"
        let isServerMode = false;
        let lastChannelIndex = 0;
        let searchTimeout;

        // --- chargement des cha√Ænes ---
        function preloadImage(src) { const img = new Image(); img.src = src; }
        function loadChannels() {
            fetch('channels.json')
                .then(r => r.json())
                .then(data => {
                    channels = Object.entries(data).map(([name, details]) => {
                        const logo = details.image || 'https://via.placeholder.com/80';
                        preloadImage(logo);
                        return { name, logo, servers: details.servers };
                    });
                    renderChannels();
                    // Au boot, la grille est pr√™te mais on laisse l'utilisateur choisir
                })
                .catch(err => console.error('Erreur lors du chargement des cha√Ænes:', err));
        }

        // --- rendu grille ---
        function renderChannels(filter = "") {
            const container = document.getElementById("channels");
            container.innerHTML = "";

            const filtered = channels.filter(ch => ch.name.toLowerCase().includes(filter.toLowerCase()));

            filtered.forEach(channel => {
                const tile = document.createElement("div");
                tile.classList.add("channel");
                tile.tabIndex = 0;

                const bg = document.createElement("div");
                bg.classList.add("channel-bg");
                bg.style.backgroundImage = `url(${channel.logo})`;
                tile.appendChild(bg);

                const name = document.createElement("div");
                name.classList.add("channel-name");
                name.textContent = channel.name;
                tile.appendChild(name);

                tile.addEventListener("click", () => showServers(channel));
                container.appendChild(tile);

                requestAnimationFrame(() => tile.classList.add("visible"));
            });

            // reset s√©lection visuelle des cartes ; si la recherche est focus, on laisse son halo
            clearActive(document.querySelectorAll('.channel'));
            if (document.activeElement !== document.getElementById('searchBar')) currentIndex = -1;
        }

        // --- helpers s√©lection / focus ---
        function focusElement(el) {
            if (!el) return;
            try { el.focus({ preventScroll: true }); } catch (_) { el.focus(); }
            el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
        }
        function clearActive(list) { list.forEach(n => n.classList.remove('is-active')); }

        function setActiveChannel(idx) {
            const tiles = document.querySelectorAll('.channel');
            if (!tiles.length) return;
            idx = Math.max(0, Math.min(idx, tiles.length - 1));

            clearActive(tiles);
            tiles[idx].classList.add('is-active');
            document.getElementById('searchBar').classList.remove('is-active');

            currentIndex = idx;
            focusElement(tiles[idx]);
        }

        // --- recherche : √©tats & √©dition ---
        const searchBar = document.getElementById('searchBar');

        function startEditingSearch() {
            // Passe l‚Äôinput en vraie √©dition (ouvre l‚ÄôIME en WebView)
            searchBar.classList.add('is-active');
            focusElement(searchBar);
            try { searchBar.click(); } catch (_) { }
        }

        function setActiveSearch() {
            // S√©lectionne la barre ET la met imm√©diatement en √©dition
            clearActive(document.querySelectorAll('.channel'));
            currentIndex = -1;
            startEditingSearch();
        }

        // IME / comportements natifs pendant saisie
        searchBar.addEventListener('focus', () => searchBar.classList.add('is-active'));
        searchBar.addEventListener('blur', () => searchBar.classList.remove('is-active'));

        // Filtrage √† la frappe
        let searchTimeout;
        searchBar.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                renderChannels(searchBar.value.trim());
            }, 120);
        });

        // Valider depuis la barre (uniquement quand elle est r√©ellement focus)
        searchBar.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const tiles = document.querySelectorAll('.channel');
                if (tiles.length) setActiveChannel(0);
            } else if (e.key === 'ArrowDown') {
                const first = document.querySelector('.channel');
                if (first) { e.preventDefault(); setActiveChannel(0); }
            }
        });

        // --- modal serveurs ---
        let isServerMode = false;
        function showServers(channel) {
            isServerMode = true;
            const serverList = document.getElementById("serverList");
            const serverContent = document.getElementById("serverContent");
            serverContent.innerHTML = `<h2>Choisissez un serveur pour "${channel.name}"</h2>`;

            Object.entries(channel.servers).forEach(([serverName, serverLink]) => {
                const div = document.createElement("div");
                div.classList.add("server");
                div.tabIndex = 0;
                div.textContent = serverName;
                div.addEventListener("click", () => window.open(serverLink, '_blank', 'noopener,noreferrer'));
                serverContent.appendChild(div);
            });

            const quitBtn = document.createElement("div");
            quitBtn.classList.add("server", "quit-btn");
            quitBtn.textContent = "Quitter";
            quitBtn.tabIndex = 0;
            quitBtn.addEventListener("click", closeServers);
            serverContent.appendChild(quitBtn);

            serverList.style.display = "block";
            setActiveServer(0);
        }

        function closeServers() {
            isServerMode = false;
            document.getElementById("serverList").style.display = "none";
            const tiles = document.querySelectorAll('.channel');
            if (tiles[lastChannelIndex]) setActiveChannel(lastChannelIndex);
        }

        function setActiveServer(idx) {
            const items = document.querySelectorAll('.server');
            if (!items.length) return;
            idx = Math.max(0, Math.min(idx, items.length - 1));

            clearActive(items);
            items[idx].classList.add('is-active');
            currentIndex = idx;
            focusElement(items[idx]);
        }

        // --- navigation clavier / D-Pad ---
        document.addEventListener('keydown', (event) => {
            // Si le modal serveurs est ouvert -> ne g√©rer que lui
            if (isServerMode) {
                const items = document.querySelectorAll('.server');
                if (!items.length) return;

                if (event.key === 'ArrowDown') { event.preventDefault(); setActiveServer(Math.min(currentIndex + 1, items.length - 1)); }
                else if (event.key === 'ArrowUp') { event.preventDefault(); setActiveServer(Math.max(currentIndex - 1, 0)); }
                else if (event.key === 'Enter') { event.preventDefault(); items[currentIndex].click(); }
                else if (event.key === 'Backspace' || event.key === 'Escape') { event.preventDefault(); closeServers(); }
                return;
            }

            const tiles = document.querySelectorAll('.channel');
            const cols = getCols();

            // Si l‚Äôinput est r√©ellement focus ‚Üí laisser ses handlers g√©rer (on sort tout de suite)
            if (document.activeElement === searchBar) return;

            // Cas ‚Äúbarre active mais pas encore en √©dition‚Äù (currentIndex = -1)
            if (currentIndex === -1) {
                if (event.key === 'Enter') { event.preventDefault(); startEditingSearch(); return; }
                if (event.key === 'ArrowDown') { const first = document.querySelector('.channel'); if (first) { event.preventDefault(); setActiveChannel(0); } return; }
                // autres touches: on ne fait rien
            }

            // Navigation dans la grille
            if (event.key === 'ArrowRight') {
                event.preventDefault();
                setActiveChannel(currentIndex === -1 ? 0 : Math.min(currentIndex + 1, tiles.length - 1));
            } else if (event.key === 'ArrowLeft') {
                event.preventDefault();
                setActiveChannel(currentIndex <= 0 ? 0 : currentIndex - 1);
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                if (currentIndex === -1) setActiveChannel(0);
                else if (currentIndex + cols < tiles.length) setActiveChannel(currentIndex + cols);
                else setActiveChannel(tiles.length - 1);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                if (currentIndex - cols >= 0) setActiveChannel(currentIndex - cols);
                else setActiveSearch(); // remonter vers la barre (ET entrer en √©dition)
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (currentIndex >= 0) { lastChannelIndex = currentIndex; tiles[currentIndex].click(); }
            }
        });

        function getCols() {
            const container = document.querySelector('.container');
            const item = document.querySelector('.channel');
            if (!container || !item) return 5;
            const cw = container.offsetWidth;
            const iw = item.offsetWidth || 1;
            return Math.max(1, Math.floor(cw / iw));
        }

        loadChannels();
    </script>



</body>

</html>