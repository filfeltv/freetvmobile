<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Streaming App</title>
    <link rel="stylesheet" href="csstv.css">
</head>

<body>
    <h1>ðŸ“º TV Streaming</h1>

    <div class="search-container">
        <input type="text" id="searchBar" class="search-bar" placeholder="Rechercher une chaÃ®ne...">
    </div>

    <div class="container" id="channels"></div>

    <div class="server-list" id="serverList">
        <div id="serverContent"></div>
    </div>

    <script>
        let channels = [];
        let currentIndex = -1;
        let isServerMode = false;
        let lastChannelIndex = 0; // MÃ©morise la position avant ouverture d'un serveur

        function loadChannels() {
            fetch('channels.json')
                .then(response => response.json())
                .then(data => {
                    channels = Object.entries(data).map(([name, details]) => ({
                        name: name,
                        logo: details.image || 'https://via.placeholder.com/80',
                        servers: details.servers
                    }));
                    renderChannels();
                })
                .catch(error => console.error('Erreur lors du chargement des chaÃ®nes:', error));
        }

        function renderChannels(filter = "") {
            const container = document.getElementById("channels");
            container.innerHTML = "";

            const filteredChannels = channels.filter(
                channel => channel.name.toLowerCase().includes(filter.toLowerCase())
            );

            filteredChannels.forEach((channel) => {
                let channelDiv = document.createElement("div");
                channelDiv.classList.add("channel");
                channelDiv.tabIndex = 0;

                let bgDiv = document.createElement("div");
                bgDiv.classList.add("channel-bg");
                bgDiv.style.backgroundImage = `url(${channel.logo})`;
                channelDiv.appendChild(bgDiv);

                let nameSpan = document.createElement("div");
                nameSpan.classList.add("channel-name");
                nameSpan.textContent = channel.name;
                channelDiv.appendChild(nameSpan);

                channelDiv.addEventListener("click", () => {
                    showServers(channel);
                });

                container.appendChild(channelDiv);
            });

            currentIndex = -1;
        }

        function showServers(channel) {
            isServerMode = true;
            const serverList = document.getElementById("serverList");
            const serverContent = document.getElementById("serverContent");

            serverContent.innerHTML = `<h2>Choisissez un serveur pour "${channel.name}"</h2>`;

            Object.entries(channel.servers).forEach(([serverName, serverLink]) => {
                let div = document.createElement("div");
                div.classList.add("server");
                div.tabIndex = 0;
                div.textContent = serverName;
                div.addEventListener("click", () => {
                    window.open(serverLink, '_blank', 'noopener,noreferrer');
                });
                serverContent.appendChild(div);
            });

            // Bouton Quitter en bas
            let quitBtn = document.createElement("div");
            quitBtn.classList.add("server", "quit-btn");
            quitBtn.textContent = "Quitter";
            quitBtn.tabIndex = 0;
            quitBtn.addEventListener("click", closeServers);
            serverContent.appendChild(quitBtn);

            serverList.style.display = "block";

            const firstServer = serverContent.querySelector('.server');
            if (firstServer) {
                firstServer.focus();
                currentIndex = 0;
            }
        }

        function closeServers() {
            isServerMode = false;
            document.getElementById("serverList").style.display = "none";
            // Revenir sur la chaÃ®ne prÃ©cÃ©dente
            const channelsList = document.querySelectorAll('.channel');
            if (channelsList[lastChannelIndex]) {
                channelsList[lastChannelIndex].focus();
                currentIndex = lastChannelIndex;
            }
        }

        const searchBar = document.getElementById('searchBar');
        searchBar.addEventListener('keydown', event => {
            if (event.key === 'Enter') {
                const val = searchBar.value.trim();
                renderChannels(val);
            }
            if (event.key === 'ArrowDown') {
                const firstChannel = document.querySelector('.channel');
                if (firstChannel) {
                    firstChannel.focus();
                    currentIndex = 0;
                }
            }
        });

        document.addEventListener("keydown", event => {
            // MODE SERVEUR (popup)
            if (isServerMode) {
                const serverElements = document.querySelectorAll('.server');
                if (!serverElements.length) return;

                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    currentIndex = (currentIndex + 1) % serverElements.length;
                    serverElements[currentIndex].focus();
                } 
                else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    currentIndex = (currentIndex - 1 + serverElements.length) % serverElements.length;
                    serverElements[currentIndex].focus();
                } 
                else if (event.key === 'Enter') {
                    event.preventDefault();
                    serverElements[currentIndex].click();
                } 
                else if ((event.key === 'Backspace' || event.key === 'Escape')) {
                    event.preventDefault();
                    closeServers();
                }
                return; // Bloque navigation arriÃ¨re-plan
            }

            // MODE GRILLE
            const elements = document.querySelectorAll('.channel');
            if (!elements.length && document.activeElement !== searchBar) return;

            if (!isServerMode && document.activeElement.classList.contains('channel') && event.key === 'ArrowUp') {
                const cols = getCols();
                if (currentIndex < cols) {
                    searchBar.focus();
                    currentIndex = -1;
                    return;
                }
            }

            const cols = getCols();

            if (event.key === 'ArrowRight') {
                event.preventDefault();
                currentIndex = (currentIndex + 1) % elements.length;
                elements[currentIndex].focus();
            } 
            else if (event.key === 'ArrowLeft') {
                event.preventDefault();
                currentIndex = (currentIndex - 1 + elements.length) % elements.length;
                elements[currentIndex].focus();
            } 
            else if (event.key === 'ArrowDown') {
                event.preventDefault();
                if (currentIndex + cols < elements.length) {
                    currentIndex += cols;
                } else {
                    currentIndex = elements.length - 1;
                }
                elements[currentIndex].focus();
            } 
            else if (event.key === 'ArrowUp') {
                event.preventDefault();
                if (currentIndex - cols >= 0) {
                    currentIndex -= cols;
                    elements[currentIndex].focus();
                } else {
                    searchBar.focus();
                    currentIndex = -1;
                }
            } 
            else if (event.key === 'Enter') {
                event.preventDefault();
                if (currentIndex >= 0) {
                    lastChannelIndex = currentIndex; // Sauvegarde avant popup
                    elements[currentIndex].click();
                }
            }
        });

        function getCols() {
            const containerWidth = document.querySelector(".container").offsetWidth;
            const itemWidth = document.querySelector(".channel")?.offsetWidth || 1;
            return Math.floor(containerWidth / itemWidth);
        }

        loadChannels();
    </script>
</body>
</html>
